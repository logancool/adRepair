<meta http-equiv="Content-Type" content="text/html; charset=utf-8"
>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/style.scss">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/formvalidation/0.6.1/css/formValidation.min.css">
    <script type="text/javascript" src="js/jszip.js"></script>
    <script type="text/javascript" src="js/FileSaver.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.2/TweenMax.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.3.min.js"
            integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"
            integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw=" crossorigin="anonymous"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/formvalidation/0.6.1/js/formValidation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/formvalidation/0.6.1/js/framework/bootstrap.js"></script>
</head>

<body>

<title>Ad Repair</title>

<div class="container">

    <!-- Top Logo -->
    <img id="logo" src="img/ft_logo.jpg"/>

    <!-- Body -->
    <div class="jumbotron vertical-center">
        <div class-='row-fluid centered text-center'>
            <label class="btn btn-primary center-block" for="inputZips">Browse</label>
            <input id="inputZips" type="file" style="display:none" multiple/>

        </div>
        <div class="row">
            <img id="check" src="img/check.png" class="center-block" style="display:none;"/>

            <div id="errors" class="text-center">
                <div id="mainErrors"></div>
                <div id="errorList"></div>
                <div id="uploadMessage"></div>
                <button id="download" class='center-block' style="display:none" onclick="download()">Download Files
                </button>

            </div>

        </div>


    </div>

    <!-- Footer -->
    <div class="navbar navbar-default navbar-fixed-bottom">
        <div class="container">
            <button class="navbar-btn btn pull-left" id="qBtn" data-toggle="modal" data-target="#qModal"> Questions
            </button>
            <p class="navbar-text pull-right">Â© 2016 - Simplicity Marketing Ltd.
                <a href=" mailto:david.silver@flashtalking.com">david.silver@flashtalking.com</a>
            </p>
        </div>
    </div>

    <!-- Questions Modal Layout -->
    <div class="modal fade" id='qModal' role="dialog">

        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">About the Tool</h4>
                </div>
                <div class="modal-body">
                    The Flashtalking Adfile Repair tool performs a series of checks and corrections on your adfile to
                    ensure
                    that it is compatible with the Flashtalking system.<br><br>
                    <ul>
                        These checks include:
                        <li>Making sure a manifest file exists</li>
                        <li>Detecting if there is a filename mismatch within the manifest</li>
                        <li>Replacing any nonsecure Edge Animate calls</li>
                        <li>Removing any unnecessary subfolders</li>
                        <li>Finding and removing special characters in file name</li>
                    </ul>
                    If no manifest file is detected, the adfile repair tool will create one for you. It will first
                    attempt to extract the dimensions from the filename. If no dimensions are found in the filename, the
                    tool will prompt you to manually input the dimensions for that adfile. All updated files will save
                    out to your specified download folder.

                </div>

            </div>

        </div>
    </div>

    <!-- Manifest Modal Layout -->
    <div class="modal fade" id="manModal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h4>Manifest Properties</h4></div>
                <div class="modal-body">
                    No manifest file was detected in your adfile. Please enter the width and height for the adfile
                    below:
                    <form data-toggle="validator" role="form">
                        <div class="form-group">
                            <div class="form-group col-sm-6">
                                <label class="control-label">Width</label>
                                <input type="text" class="form-control" name="manW"
                                       placeholder="728" required>
                            </div>

                            <div class="form-group col-sm-6">
                                <label class="control-label">Height</label>
                                <input type="text" class="form-control" name="manH"
                                       placeholder="90" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

</body>
</html>

<script type="text/javascript">


    //////-----START----//////

    //call inputFiles when files are loaded
    document.getElementById('inputZips').addEventListener('change', inputFiles, false);

    document.getElementById("check").style.opacity = 0;
    document.getElementById("errorList").innerHTML = "";
    document.getElementById("mainErrors").innerHTML = "";
    document.getElementById("uploadMessage").innerHTML = "";
    document.getElementById("check").style.opacity = 0;
    document.getElementById("errorList").style.opacity = 0;
    document.getElementById("mainErrors").style.opacity = 0;
    document.getElementById("uploadMessage").style.opacity = 0;
    document.getElementById("download").style.display = "none";
    document.getElementById("download").style.opacity = 0;

    var errors = warnings = messages = {};
    var log = {
        error : function(file,message) {
            //if array is empty, create it
            if (errors[file.name] == null) {
                errors[file.name] = [];
            }
            else {
                errors[file.name].push(message);
            }
        },
        warning : function(file,message) {
            //if array is empty, create it
            if (warnings[file.name] == null) {
                warnings[file.name] = [];
            }
            else {
                warnings.push(file.name, message);
            }
        },
        message: function(file,msg) {
            //if array is empty, create it
            if (errors[file.name] == null) {
                errors[file.name] = [];
            }
            else {
            messages[file.name].push(msg);
            }
        }
    };

    /**
     * stores the file list and runs the repair
     */

    function inputFiles(input) {

        //store the list of files as fileList
        var fileList = input.target.files;

        //run the repair system
        runAdRepair(fileList);

    }

    function runAdRepair(fileList) {
        //for each file in the list
        for (var i = 0; i < fileList.length; i++) {
            //set current filename
            var file = fileList[i];
            var filename = fileList[i].name;
            
            // use a callback to wait for files to be loaded.
            repair(file);

        }
    }

    function print(content) {
        console.log(content);
    }

    function isHTML(file){
        return (file.name.lastIndexOf(".html") > -1);
    }
    function isDir(file){
        return
    }
    function noManifest(){

    }
    /**
     * @param file - the file to be unziped
     * @returns a file list inside the zipfile
     */
    function repair(file) {

        //confirm is zip before trying to unzip
        if (getFileExt(file.name) == 'zip') {

            //variable holder for repaired zip file list
            var rFiles = [];

            //initial and load file reader
            var reader = new FileReader();
            reader.onload = function (e) {

                var zFList = new JSZip(e.target.result);

                for (var filename in zFList.files) {
                    //TODO: check filename for each file in list
                    var file = zFList.files[filename];

                    /*-------BEGIN CHECKS -----*/

                    if (isFLA(file)){
                        log.message("FLA file found and removed");
                        //continue?
                    }

                    //
                    else if (isHTML(file)){
                        rmSpecialChars(file);
                        if (hasHtmlAnimateCall(file) && !(animateCallIsSecure(file))){
                            //replaceAnimateCall(file);
                            log.error(file, "Replaced insecure call")
                        }
                        if (!(hasAPI(file))){
                            //addAPI(file);
                            log.error(file, "Api was not found")
                        }
                    }

                    //
                    else if (isManifest(file)){
                        if (!(manMatchesHTML(file, htmlFN))){
                            log.error(file, "Manifest filename did not match html filename");
                        }
                    }

                    else if (isOSXFolder(file)) {
                        //removeOSXFolder(file);
                        log.error(file, "Hidden folder found and removed");
                    }

                    else if (isDir(file)){
                        findSubFolder(file);
                        log.warning(file, "Nested directory was found and was updated to root")
                    }

                    //Push each file being repaired into an array called rFiles
                    rFiles.push(file);

                }
                if (noManifest()){
                    //createManifest();
                    //createManModal();
                    //valManDims();
                }

                /*---FINISH ZIPPING AND ALLOW DOWNLOAD --*/
                makeZip();
                checkZip();
                download();
            };
            reader.readAsArrayBuffer(file);
        };

    }

    // ---- HELPERS -- //

    /**
     * Helper function returning the file ext string
     */

    function getFileExt(filename) {
        return filename.split('.').pop();
    }

    /**
     * @returns true if the file is called manifest.js
     */
    function isManifest(file_name) {
        return (file_name == "manifest.js");
    }

    /**
     * @returns true if the file is an fla
     */
    function isFLA(fInZip) {
        //Check for FLA
        return (fInZip.name.lastIndexOf(".fla") > -1);
    }

    /**
     * returns true if the file is a hidden MACOSX folder
     */
    function isOSXFolder(fInZip) {
        return (!(fInZip.name.substr(fInZip.name.lastIndexOf("/") - 8, 8) == "__MACOSX"));
    }

    function hasHtmlAnimateCall(fInZip) {

        var htmlText = fInZip.asText();

        //confirm the file is an html and there is a slash in it
        if ((fInZip.name.split('.').pop() == "html") && (htmlText.lastIndexOf("/") > -1)) {
            return true;
        }
    }

    function hasAPI(fInZip) {
        //CHECK HTML CODE FOR API
        var htmlText = fInZip.asText();
        if (htmlText.lastIndexOf("html5API.js") > -1) {
            return true;
        }
    }

    function animateCallIsSecure(fInZip) {
        //CHECK IF EDGE ANIMATE CALL IS SECURE
        var htmlText = fInZip.asText();
        return (htmlText.lastIndexOf("http://animate.adobe.com/") > -1);
    }

    function replaceAnimateCall(fInZip) {
        var end = htmlText.lastIndexOf("</html>")
        var animateReplace = "https://animate.adobe.com/"
        htmlText = [htmlText.slice(0, animate - 1), '"' + animateReplace, htmlText.slice(animate + animateReplace.length - 1, end + 7)].join('');
    }

    function removeExtension(filename){
        var lastDotPosition = filename.lastIndexOf(".");
        if (lastDotPosition === -1) return filename;
        else return filename.substr(0, lastDotPosition);
    }
    /**
     * Removes all non A-Z, 0-9 non-sensitive chars
     * @param filename - original string containing possible removable chars
     * @return reformatted filename
     */
    function rmSpecialChars(file) {

        //store as a new var to see if the filename has been altered
        var newFN = file.name.split(' ').join('_');

        if (newFN != file.name) {
            log.message(file, "Found and removed whitespace");
        }

        newFN = file.name.replace(/[^\w.-]+/g, "");

        if (newFN != file.name) {
            log.message(file, "Found and removed special characters");
        }
        console.log(messages);
        return newFN;
    }

    /**
     *
     * @param subfolder
     */
    function findSubFolder(subfolder) {
        //FIND SUBFOLDER INDEX
        if (subfolder) {
            for (var f = 0; f < files.length; f++) {
                if (files[f].name == subfolderName + "/") {
                    subfolderIndex = f;
                    break;
                }
            }
        }
    }

    function manMatchesHTML(man, html) {
        //CHECK MANIFEST TO SEE IF NAME MATCHES HTML FILENAME
        //-------------------------------------------------------
        var slash = mainHTML.lastIndexOf("/");
        htmlFile = mainHTML.substring(slash + 1);


        if (manifestFound) {
            manifestText = files[manifest].asText();
            manifestFile = files[manifest].name;
            var filename_m = manifestText.lastIndexOf("filename");
            var html_m = manifestText.lastIndexOf(".html");
            var end_m = manifestText.lastIndexOf("})")
            manifestWrite = true;

            var quotes = [];

            for (var q = 0; q <= manifestText.length; q++) {
                if (manifestText[q] === '"') quotes.push(q);
                if (quotes.length == 3) {
                    break;
                }
            }
            console.log("MANIFEST FILENAME: " + manifestText.substr(quotes[2] + 1, (html_m - quotes[2]) + 4))
            if (manifestText.substr(quotes[2] + 1, (html_m - quotes[2]) + 4) != htmlFile) {
                manifestText = [manifestText.slice(0, quotes[2] + 1), htmlFile, manifestText.slice(html_m + 5, end_m + 3)].join('');
                fileNameMismatch = true;
            }
            makeZip();

        }
    }

    function createManifest() {
        //IF NO MANIFEST EXISTS CREATE ONE
        var width = "";
        var height = "";

        var indices = [];
        var indices2 = [];

        for (var d = 0; d < fileName.length; d++) {
            if (fileName[d] === "x") indices.push(d);
        }

        for (var c = 0; c < mainHTML.length; c++) {
            if (mainHTML[c] === "x") indices2.push(c);
        }
        if (manifestFound != true) {
            noManifestFound = true;
            //CHECK MAIN FILE NAME FOR DIMENSIONS
            for (x = 0; x < indices.length; x++) {
                if (Number(fileName.substr(indices[x] - 3, 3) % 1) == 0) {
                    width = fileName.substr(indices[x] - 3, 3);
                }
                //Check 2 or 3 characters past the x to determine the height
                if (Number(fileName.substr(indices[x] + 1, 3) % 1) == 0 && fileName[indices[x] + 3] != ".") {
                    height = fileName.substr(indices[x] + 1, 3);
                    fileName[indices[x] + 3]
                } else if (Number(fileName.substr(indices[x] + 1, 2) % 1) == 0) {
                    height = fileName.substr(indices[x] + 1, 2);
                }
            }
            //CHECK MAIN HTML FILE NAME FOR DIMENSIONS
            for (var y = 0; y < indices2.length; y++) {
                if (Number(mainHTML.substr(indices2[y] - 3, 3) % 1) == 0 && width == "") {
                    width = mainHTML.substr(indices2[y] - 3, 3);
                }
                //Check 2 or 3 characters past the x to determine the height
                if (height == "") {
                    if (Number(mainHTML.substr(indices2[y] + 1, 3) % 1) == 0 && mainHTML[indices2[y] + 3] != ".") {
                        height = mainHTML.substr(indices2[y] + 1, 3);
                    } else if (Number(mainHTML.substr(indices2[y] + 1, 2) % 1) == 0) {
                        height = mainHTML.substr(indices2[y] + 1, 2);
                    }
                }
            }
            if (width == "" && height == "") {
                // document.getElementById("background").style.display = "block";
                //  document.getElementById("manifestDialog").innerHTML = "No manifest file was detected in your adfile. Please enter the width and height for the adfile below:<br><br>" + fileName;
                //  console.log("file name for manifest: " + fileName);
                //  $("#dialog").dialog("open");
            }
            newManifest = 'FT.manifest({\n"filename": "' + htmlFile + '",\n"width": ' + width + ',\n"height": ' + height + ',\n"clickTagCount": 1\n});'
        }
    }

    function makeZip() {

        var zip = new JSZip();

        if (subfolder != true) {
            for (i = 0; i < files.length; i++) {
                var fla = files[i].name.lastIndexOf(".fla");
                if (manifestWrite == true && files[i].name == manifestFile) {
                    zip.file(files[i].name, manifestText);
                } else {
                    if (files[i].name.substring(0, 8) != "__MACOSX" && files[i].name != orgHTML && files[i].name.substr(files[i].name.length - 4) != "html" && fla <= -1) {
                        zip.file(files[i].name, files[i].asUint8Array());
                    }
                }
                if (manifestFound != true) {
                    zip.file("manifest.js", newManifest);
                }
            }
        } else {
            console.log("SUBFOLDER NAME: " + subfolderName)
            for (i = 0; i < files.length; i++) {
                var fla = files[i].name.lastIndexOf(".fla");
                if (manifestWrite == true && files[i].name == manifestFile) {
                    zip.file(files[i].name.substring(subfolderName.length + 1), manifestText);
                } else {
                    if (files[i].name.substr(macIndex, 8) != "__MACOSX" && files[i].name.substr(0, 8) != "__MACOSX" && files[i].name != orgHTML && files[i].name.substr(files[i].name.length - 4) != "html" && files[i].name != subfolderName + "/" && fla <= -1) {
                        zip.file(files[i].name.substring(subfolderName.length + 1), files[i].asUint8Array());
                    }

                }
                if (manifestFound != true) {
                    zip.file("manifest.js", newManifest);
                }
            }
        }

        zip.file(mainHTML, htmlText);

        var content = zip.generate({
            type: "blob"
        });

        console.log("FILENAME: " + fileName)
        // see FileSaver.js

        zipArrayContent.push(content);
        zipArrayFilename.push(fileName);
        //saveAs(content, fileName);


        f++;
        var inputFile = document.getElementById("inputFile");
        if (f < inputFile.files.length) {
            inputFiles();
        }
        checkZip();

    }

    function checkZip() {
        var inputFile = document.getElementById("inputFile");
        if (inputFile.files.length == zipArrayFilename.length && generate != true) {
            generateErrors();
            generate = true;

        }

    }

    function download() {
        var inputFile = document.getElementById("inputFile");
        for (var i = 0; i < inputFile.files.length; i++) {
            saveAs(zipArrayContent[i], zipArrayFilename[i]);
        }
    }

    function generateErrors() {

        var errorList = document.getElementById("errorList");
        var mainErrors = document.getElementById("mainErrors");
        var check = document.getElementById("check");
        var uploadMessage = document.getElementById("uploadMessage");
        var downloadButton = document.getElementById("download");

        if (subfolder) {
            problems.push("Subfolders detected and removed");
        }
        if (specialCharacters) {
            problems.push("Special characters found and removed");
        }
        if (whiteSpace) {
            problems.push("Whitespaces found and removed")
        }
        if (noManifestFound) {
            problems.push("No manifest file found");
        }
        if (fileNameMismatch) {
            problems.push("Filename mismatch found");
        }
        if (nonSecureCalls) {
            problems.push("Nonsecure Edge Animate call detected and replaced")
        }
        if (flaFound) {

        }

        if (apiArray.length >= 1 && f > apiArray.length) {
            uploadMessage.innerHTML = "Upload the following files to the <b>Base Files</b> tab:<br><br>";
            for (var aa = 0; aa < apiArray.length; aa++) {
                uploadMessage.innerHTML += '<span style="font-size:13px">' + apiArray[aa] + '</span><br>';
            }
            uploadMessage.innerHTML += "<br>Upload the following files to the <b>Standard Ads</b> tab:<br><br>";
            for (var aa = 0; aa < nonApiArray.length; aa++) {
                uploadMessage.innerHTML += '<span style="font-size:13px">' + nonApiArray[aa] + '</span><br>';
            }
            uploadMessage.innerHTML += "<br>"
        }
        if (apiArray.length > 1 && f == apiArray.length) {
            uploadMessage.innerHTML = "Please upload your files to the <b>Base Files</b> tab";
        }
        if (apiArray.length == 1 && f == 1) {
            uploadMessage.innerHTML = "Please upload your file to the <b>Base Files</b> tab";
        }
        if (apiArray.length < 1) {
            if (f > 1) {
                uploadMessage.innerHTML = "Please upload your files to the <b>Standard Ads</b> tab";
            } else {
                uploadMessage.innerHTML = "Please upload your file to the <b>Standard Ads</b> tab";
            }
        }


        TweenLite.to(check, 1, {
            alpha: 1,
            ease: Power2.easeOut
        });
        TweenLite.to(check, .8, {
            scaleX: 0,
            ease: Power4.easeIn,
            delay: .2
        });
        TweenLite.to(check, .5, {
            scaleX: 1,
            ease: Power4.easeOut,
            delay: 1
        });
        TweenLite.to(mainErrors, .5, {
            alpha: 1,
            delay: 1
        });
        TweenLite.to(errorList, .5, {
            alpha: 1,
            delay: 1.5
        });
        TweenLite.to(uploadMessage, .5, {
            alpha: 1,
            delay: 1.8
        });
        if (problems.length > 0) {
            downloadButton.style.display = "block";
            TweenLite.to(downloadButton, .5, {
                alpha: 1,
                delay: 2
            });
        }

        checkAnimated = true;

        if (problems.length == 1) {
            mainErrors.innerHTML += problems.length + " issue detected and resolved<br><b>";
        }
        if (problems.length > 1) {
            mainErrors.innerHTML += problems.length + " issues detected and resolved<br><b>";
        }
        if (problems.length <= 0) {
            mainErrors.innerHTML += "No issues detected";
        }
        for (e = 0; e < problems.length; e++) {
            errorList.innerHTML += problems[e] + "<br>";
        }
    }

    //Create Mainfest Modal
    function createManModal() {
        // Get the modal
        var modal = document.getElementById('qModal');

        // Get the button that opens the modal
        var btn = document.getElementById("qBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on the button, open the modal
        btn.onclick = function () {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    //Validate Manifest Dimensions
    function valManDims() {

        //returns true if the value is in the array
        function isIn(value, array) {
            if (array.indexOf(value) != -1) {
                return true;
            }
            else {
                return false;
            }
        }

        //returns if the width or height (dim) is a common dimension (value)
        function isCommonDim(dim, value) {
            if (dim == 'manW') {
                var commonW = [1, 88, 120, 120, 125, 160, 180, 234, 240, 250, 300, 336, 468, 728];
                if (isIn(value, commonW)) {
                    return true;
                }
                else {
                    return false;
                }
            }
            else if (dim == 'manH') {
                var commonH = [1, 31, 60, 90, 125, 150, 240, 250, 280, 400, 600];
                if (isIn(value, commonH)) {
                    return true;
                }
                else {
                    return false;
                }
            }
            else return false;
        }

        $('#manModal').formValidation({
            framework: 'bootstrap',
            icon: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',

                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                manW: {
                    validMessage: 'Warning: the value entered is an uncommon width',
                    validators: {
                        notEmpty: {
                            message: 'A width is required'
                        },
                        between: {
                            min: 1,
                            max: 9999,
                            message: 'The width must be a number between 1 and 9999'
                        },
                        integer: {
                            min: 0,
                            message: 'The value is not an integer',
                            // The default separators
                            thousandsSeparator: '',
                            decimalSeparator: '.'
                        }
                    }
                },
                manH: {
                    validMessage: 'Warning: the value entered is an uncommon height',
                    validators: {
                        notEmpty: {
                            message: 'A height is required'
                        },
                        between: {
                            min: 1,
                            max: 9999,
                            message: 'The height must be a number between 1 and 9999'
                        },
                        integer: {
                            min: 0,
                            message: 'The value is not an integer',
                            // The default separators
                            thousandsSeparator: '',
                            decimalSeparator: '.'
                        },
                        // The warning message
                        warning: {
                            message: 'Warning: the value entered is an uncommon height'
                        }
                    }
                }
            }
        });
        // This event will be triggered when the field passes given validator
        $('#manModal').on('success.field.fv', function (e, data) {

            // Mark the field as invalid
            function addWarning(data) {
                data.element
                        .closest('.form-group')
                        .removeClass('has-success')
                        .addClass('has-warning help-block validMessage')
                //add message
                var $span = $('<small/>')
                        .attr('data-field', data.field)
                        .insertAfter(data.element);
                // Retrieve the valid message via getOptions()
                var message = data.bv.getOptions(data.field).validMessage;

                if (message) {
                    $span.html(message);
                }
            }

            function removeWarning(data) {
                data.element     // Get the field element
                        .closest('.form-group')     // Get the field parent
                        .removeClass('has-warning help-block validMessage') //remove the warning
                        .addClass('has-success') // add success!
            }

            //The live value of the users input
            var input = parseInt(data.element[0].value);

            //check if there's warnings for either field
            if (!(isCommonDim(data.field, input))) {
                // The width is not common - add warning
                addWarning(data);
            }
            //reset to green
            else {
                removeWarning(data);
            }
        });
    }

    //Display Manifest Modal
    //$('#manModal').modal('show');



</script>
